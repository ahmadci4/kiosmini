<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KIOS MINI - KASIR PRO</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root {
            --primary: #2563eb; --secondary: #64748b; --danger: #ef4444;
            --success: #22c55e; --warning: #f59e0b; --bg: #f1f5f9; --text: #1e293b;
            --header-bg: #1e293b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* HEADER */
        header { background: var(--header-bg); color: white; padding: 10px 15px; flex-shrink: 0; display: flex; flex-direction: column; gap: 5px; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-brand { font-weight: bold; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .header-info { font-size: 0.75rem; color: #cbd5e1; text-align: right; }
        
        /* NAVIGATION */
        nav { display: flex; gap: 5px; overflow-x: auto; margin-top: 5px; padding-bottom: 2px; }
        nav::-webkit-scrollbar { display: none; }
        nav button { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; 
            padding: 6px 12px; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; cursor: pointer;
        }
        nav button.active { background: var(--primary); border-color: var(--primary); font-weight: bold; }

        /* LAYOUT MAIN */
        main { flex: 1; display: none; height: 100%; overflow: hidden; position: relative; }
        main.show { display: flex; }

        /* --- HALAMAN KASIR (FIXED LAYOUT) --- */
        #view-kasir { flex-direction: row; height: 100%; }
        
        .catalog-area { 
            flex: 6; display: flex; flex-direction: column; 
            background: #f8fafc; border-right: 1px solid #e2e8f0; 
            padding: 10px; height: 100%; overflow: hidden;
        }
        
        .grid-container { flex: 1; overflow-y: auto; padding-bottom: 50px; }
        
        .cart-area { 
            flex: 4; display: flex; flex-direction: column; 
            background: white; height: 100%; min-width: 320px; 
            box-shadow: -2px 0 10px rgba(0,0,0,0.05); z-index: 10;
        }
        
        .cart-list { 
            flex: 1; overflow-y: auto; padding: 10px; 
            /* Agar list bisa discroll tapi footer tetap diam */
        }
        
        .cart-footer { 
            flex-shrink: 0; padding: 15px; 
            background: white; border-top: 1px solid #eee; 
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            #view-kasir { flex-direction: column; }
            .catalog-area { flex: 1; border-right: none; }
            .cart-area { flex: 1; min-width: 100%; border-top: 2px solid #ddd; height: 40%; }
        }

        /* CARD PRODUK */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; 
            height: 110px; display: flex; flex-direction: column; justify-content: space-between; 
            position: relative; transition: transform 0.1s; cursor: pointer;
        }
        .card:active { transform: scale(0.96); border-color: var(--primary); background: #eff6ff; }
        .card.low { border: 2px solid var(--warning); background: #fffbeb; }
        .card.out { border: 2px solid var(--danger); opacity: 0.6; pointer-events: none; background: #fee2e2; }
        
        .badge { position: absolute; top: 0; right: 0; font-size: 0.6rem; padding: 2px 6px; border-bottom-left-radius: 6px; color: white; font-weight: bold; }
        .p-name { font-weight: 600; font-size: 0.85rem; line-height: 1.2; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .p-price { font-weight: bold; color: var(--primary); font-size: 0.9rem; }
        
        /* CART ITEM */
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        .qty-control { display: flex; align-items: center; gap: 5px; background: #f1f5f9; padding: 2px; border-radius: 4px; }
        .qty-btn { width: 28px; height: 28px; border: none; background: white; font-weight: bold; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); color: var(--primary); }

        /* BUTTONS */
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; width: 100%; font-size: 1rem; }
        .btn-pay { background: var(--success); color: white; display: flex; justify-content: space-between; align-items: center; padding: 15px; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .bg-blue { background: var(--primary); color: white; }
        .bg-red { background: var(--danger); color: white; }
        .bg-yellow { background: var(--warning); color: black; }
        
        /* DASHBOARD WIDGETS */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; }
        .alert-box { background: #fff7ed; border-left: 4px solid var(--warning); padding: 10px; margin-bottom: 15px; border-radius: 4px; font-size: 0.9rem; }

        /* OTHER PAGES */
        #view-dashboard, #view-produk, #view-hutang, #view-laporan { padding: 15px; overflow-y: auto; flex-direction: column; }
        .form-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .input-line { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin: 5px 0 10px; }
        
        /* TABLE */
        .table-wrap { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; }
        th { background: #f8fafc; text-align: left; padding: 12px; font-size: 0.85rem; color: #64748b; }
        td { padding: 12px; border-top: 1px solid #f1f5f9; font-size: 0.9rem; }

        /* FOOTER */
        footer { 
            background: #fff; border-top: 1px solid #e2e8f0; padding: 10px; 
            text-align: center; font-size: 0.8rem; color: #64748b; flex-shrink: 0;
        }

        /* MODAL */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; max-height: 90vh; overflow-y: auto; }
        .pay-input { font-size: 1.5rem; text-align: right; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; font-weight: bold; color: var(--primary); }

        /* CAMERA */
        #cam-layer { position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:2000; display:none; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

<header>
    <div class="header-top">
        <div class="header-brand">
            <img id="headLogo" style="height:30px; display:none; background:white; border-radius:4px;">
            <span id="headTitleText">KIOS MINI</span>
        </div>
        <div class="header-info">
            <div id="dateMasehi">Loading...</div>
            <div id="dateHijri" style="color:#fbbf24; font-weight:bold;">Loading...</div>
            <div id="prayTime" style="font-size:0.7rem; margin-top:2px;">Waktu Sholat: --:--</div>
        </div>
    </div>
    <nav>
        <button onclick="nav('dashboard')" id="nav-dashboard">üè† Home</button>
        <button onclick="nav('kasir')" id="nav-kasir" class="active">üõí Kasir</button>
        <button onclick="nav('produk')" id="nav-produk">üì¶ Stok</button>
        <button onclick="nav('hutang')" id="nav-hutang">üìí Kasbon</button>
        <button onclick="nav('laporan')" id="nav-laporan">üìä Laporan</button>
    </nav>
</header>

<!-- DASHBOARD -->
<main id="view-dashboard" style="overflow-y:auto;">
    <!-- Stock Alert -->
    <div id="stockAlert" class="alert-box" style="display:none;">
        <div style="font-weight:bold; color:#c2410c; margin-bottom:5px;">‚ö†Ô∏è PERINGATAN STOK MENIPIS</div>
        <div id="stockAlertList"></div>
    </div>

    <!-- Stats -->
    <div class="stat-grid">
        <div class="stat-card">
            <div style="font-size:0.8rem; color:#64748b;">Omzet Hari Ini</div>
            <div id="dashOmzet" style="font-size:1.4rem; font-weight:bold; color:var(--primary);">Rp 0</div>
            <div id="dashTerjual" style="font-size:0.8rem; color:#64748b;">0 Item</div>
        </div>
        <div class="stat-card">
            <div style="font-size:0.8rem; color:#64748b;">Total Piutang</div>
            <div id="dashHutang" style="font-size:1.4rem; font-weight:bold; color:var(--danger);">Rp 0</div>
            <div style="font-size:0.8rem; color:#64748b;">Belum Lunas</div>
        </div>
    </div>

    <!-- Jadwal Sholat Info -->
    <div class="form-card" style="background: linear-gradient(to right, #1e293b, #0f172a); color:white;">
        <h4 style="margin:0 0 10px 0; color:#fbbf24;">üïå Jadwal Sholat Hari Ini</h4>
        <div id="jadwalSholatList" style="display:flex; justify-content:space-between; font-size:0.85rem;">
            Loading...
        </div>
    </div>

    <!-- Settings (Dikembalikan) -->
    <div class="form-card">
        <h3 style="margin-top:0;">üõ†Ô∏è Pengaturan Toko & Logo</h3>
        
        <label style="font-size:0.85rem; font-weight:bold;">Nama Toko</label>
        <input id="shopName" class="input-line" onchange="saveSettings()" placeholder="Nama Toko Anda">
        
        <label style="font-size:0.85rem; font-weight:bold;">Logo Toko (Muncul di Header & Struk)</label>
        <div style="display:flex; gap:10px; align-items:center;">
            <img id="logoPreview" style="height:50px; width:50px; object-fit:contain; border:1px dashed #ccc; padding:2px; border-radius:5px; display:none;">
            <input type="file" accept="image/*" onchange="handleLogo(this)">
        </div>
        <p style="font-size:0.75rem; color:#666;">*Logo otomatis tersimpan</p>

        <label style="font-size:0.85rem; font-weight:bold;">Footer Struk</label>
        <input id="shopFooter" class="input-line" onchange="saveSettings()" placeholder="Contoh: Terimakasih atas kunjungan anda">
        
        <div style="border-top:1px solid #eee; margin:10px 0;"></div>
        
        <button class="btn bg-yellow" onclick="testPrintRawBT()">üñ®Ô∏è Test Print Struk (RawBT)</button>
        <div style="font-size:0.8rem; color:#666; margin-top:5px;">*Pastikan aplikasi RawBT sudah terinstall</div>
    </div>

    <button class="btn bg-red" onclick="resetDaily()">üóëÔ∏è Reset Data Hari Ini</button>
</main>

<!-- KASIR -->
<main id="view-kasir" class="show">
    <div class="catalog-area">
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <input id="search" style="flex:1; padding:10px; border:1px solid #cbd5e1; border-radius:8px;" placeholder="Cari Nama / Scan Barcode..." onkeyup="renderProducts()">
            <button onclick="startCam()" style="background:#334155; color:white; border:none; padding:0 15px; border-radius:8px;">üì∑</button>
        </div>
        <div class="grid-container">
            <div id="grid" class="grid"></div>
        </div>
    </div>
    
    <div class="cart-area">
        <div style="padding:15px; font-weight:bold; border-bottom:1px solid #f1f5f9; background:#f8fafc;">
            üõí Keranjang Belanja
        </div>
        <div id="cart" class="cart-list">
            <!-- Item keranjang masuk sini -->
        </div>
        <div class="cart-footer">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem; color:#64748b;">
                <span>Total Belanja</span>
                <span id="cartCount">0 Item</span>
            </div>
            <button class="btn btn-pay" onclick="openPay()">
                <span>BAYAR</span>
                <span id="cartTotal" style="font-size:1.3rem;">Rp 0</span>
            </button>
        </div>
    </div>
</main>

<!-- STOK PRODUK -->
<main id="view-produk">
    <div class="form-card">
        <h3 style="margin-top:0;">Tambah Produk</h3>
        <input type="hidden" id="pId">
        <div style="display:flex; gap:10px;">
            <input id="pCode" class="input-line" placeholder="Scan Barcode / Kode" style="flex:1">
            <input id="pName" class="input-line" placeholder="Nama Produk" style="flex:2">
        </div>
        <div style="display:flex; gap:10px;">
            <input id="pPrice" type="number" class="input-line" placeholder="Harga Jual">
            <input id="pStock" type="number" class="input-line" placeholder="Stok Awal">
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn bg-blue" onclick="saveProduct()">SIMPAN</button>
            <button class="btn bg-yellow" onclick="resetForm()">BATAL</button>
        </div>
    </div>
    
    <div style="margin-bottom:10px; display:flex; gap:10px;">
        <button class="btn bg-blue" style="font-size:0.8rem; padding:8px;" onclick="downloadBackup()">‚¨áÔ∏è Backup Data</button>
        <label class="btn bg-yellow" style="font-size:0.8rem; padding:8px; width:auto; display:inline-block; margin:0;">
            ‚¨ÜÔ∏è Restore
            <input type="file" style="display:none;" onchange="restoreData(this)">
        </label>
    </div>

    <div class="table-wrap">
        <table id="tProduct">
            <thead><tr><th>Produk</th><th>Harga</th><th>Stok</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<!-- KASBON -->
<main id="view-hutang">
    <h3>üìí Daftar Kasbon (Belum Lunas)</h3>
    <div class="table-wrap">
        <table id="tDebt">
            <thead><tr><th>Tanggal</th><th>Pelanggan</th><th>Total</th><th>Aksi</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<!-- LAPORAN -->
<main id="view-laporan">
    <h3>üìä Riwayat Transaksi</h3>
    <div class="table-wrap">
        <table id="tHistory">
            <thead><tr><th>Waktu</th><th>Total</th><th>Info</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</main>

<!-- FOOTER -->
<footer>
    <div>Aplikasi KIOS MINI Pro v2.5</div>
    <div>Developed by <b>Ahmad Stimik</b> | Kendala? Hubungi: <a href="mailto:ahmadstimik15@gmail.com" style="color:#2563eb;">ahmadstimik15@gmail.com</a></div>
</footer>

<!-- MODAL BAYAR -->
<div id="modalPay" class="modal-bg">
    <div class="modal">
        <h3 style="margin:0; text-align:center;">Pembayaran</h3>
        
        <div style="background:#f1f5f9; padding:15px; border-radius:8px;">
            <div style="display:flex; justify-content:space-between;">
                <span>Total Tagihan:</span> <b id="payTotalDisplay">Rp 0</b>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:5px; color:var(--success);">
                <span>Kembali:</span> <b id="payChangeDisplay">Rp 0</b>
            </div>
        </div>

        <div style="display:flex; gap:5px;">
            <button id="btnMethodCash" class="btn bg-blue" onclick="setMethod('cash')" style="flex:1;">TUNAI</button>
            <button id="btnMethodDebt" class="btn" style="background:#ccc; flex:1;" onclick="setMethod('debt')">KASBON</button>
        </div>

        <!-- AREA CASH -->
        <div id="areaCash">
            <input id="payInput" type="number" class="pay-input" placeholder="Uang diterima" oninput="calcPay()">
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-top:5px;">
                <button class="btn" style="border:1px solid #ccc; font-size:0.8rem; padding:8px;" onclick="quickPay(0)">Pas</button>
                <button class="btn" style="border:1px solid #ccc; font-size:0.8rem; padding:8px;" onclick="quickPay(10000)">10k</button>
                <button class="btn" style="border:1px solid #ccc; font-size:0.8rem; padding:8px;" onclick="quickPay(50000)">50k</button>
                <button class="btn" style="border:1px solid #ccc; font-size:0.8rem; padding:8px;" onclick="quickPay(100000)">100k</button>
            </div>
        </div>

        <!-- AREA DEBT -->
        <div id="areaDebt" style="display:none;">
            <input id="debtName" class="input-line" placeholder="Nama Pelanggan (Wajib)" style="font-size:1.1rem;">
        </div>

        <button id="btnProcess" class="btn bg-blue" onclick="processTx()" disabled>BAYAR & CETAK</button>
        <button class="btn bg-red" onclick="document.getElementById('modalPay').style.display='none'">BATAL</button>
    </div>
</div>

<!-- CAMERA -->
<div id="cam-layer">
    <div id="reader" style="width:100%; max-width:500px;"></div>
    <button class="btn bg-red" style="margin-top:20px; width:auto;" onclick="stopCam()">Tutup Kamera</button>
</div>

<!-- SOUND -->
<audio id="sndOk" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
<audio id="sndNew" src="https://assets.mixkit.co/active_storage/sfx/2573/2573-preview.mp3"></audio>

<script>
    // GLOBAL DATA
    let db = { prod: [], cart: [], hist: [], debts: [], set: {name:'KIOS MINI', footer:'Terimakasih', logo:''} };
    let buffer = '', scanTimer;
    let scanner = null;
    let payMethod = 'cash';
    let totPay = 0;

    // INIT
    window.onload = () => {
        if(localStorage.getItem('kasir_db')) db = JSON.parse(localStorage.getItem('kasir_db'));
        if(!db.debts) db.debts = []; // Compat
        if(!db.set.logo) db.set.logo = '';

        initSettings();
        renderProducts();
        renderTableProd();
        renderHistory();
        renderDebts();
        updateDash();
        
        // Fitur Islami
        updateIslamicDate();
        fetchPrayerTimes();

        // Scanner Listener
        document.addEventListener('keydown', e => {
            if(e.target.tagName === 'INPUT') return;
            if(e.key === 'Enter') {
                if(buffer.trim()) handleScan(buffer.trim());
                buffer = '';
            } else {
                if(e.key.length === 1) buffer += e.key;
                clearTimeout(scanTimer);
                scanTimer = setTimeout(() => buffer='', 200);
            }
        });
    };

    function save() {
        localStorage.setItem('kasir_db', JSON.stringify(db));
        updateDash();
    }

    function nav(id) {
        document.querySelectorAll('main').forEach(e => e.classList.remove('show'));
        document.getElementById('view-'+id).classList.add('show');
        document.querySelectorAll('nav button').forEach(e => e.classList.remove('active'));
        document.getElementById('nav-'+id).classList.add('active');
        if(id==='hutang') renderDebts();
    }

    // --- PRODUK ---
    function saveProduct() {
        let id = document.getElementById('pId').value;
        let code = document.getElementById('pCode').value.trim() || 'M-'+Date.now();
        let name = document.getElementById('pName').value.trim();
        let price = parseInt(document.getElementById('pPrice').value);
        let stock = parseInt(document.getElementById('pStock').value);
        
        if(!name || !price) return alert("Nama & Harga wajib!");

        if(id) {
            let i = db.prod.findIndex(x => x.id == id);
            if(i>-1) db.prod[i] = {id, code, name, price, stock};
        } else {
            if(db.prod.find(x => x.code == code)) return alert("Barcode sudah ada!");
            db.prod.push({id:Date.now(), code, name, price, stock});
        }
        save(); resetForm(); renderTableProd(); renderProducts(); alert("Tersimpan");
    }

    function editProd(id) {
        let p = db.prod.find(x => x.id == id);
        document.getElementById('pId').value = p.id;
        document.getElementById('pCode').value = p.code;
        document.getElementById('pName').value = p.name;
        document.getElementById('pPrice').value = p.price;
        document.getElementById('pStock').value = p.stock;
        nav('produk');
    }

    function delProd(id) {
        if(confirm('Hapus produk ini?')) {
            db.prod = db.prod.filter(x => x.id != id);
            save(); renderTableProd(); renderProducts();
        }
    }

    function renderTableProd() {
        let h = '';
        db.prod.slice().reverse().forEach(p => {
            h += `<tr>
                <td><b>${p.name}</b><br><small style="color:#666">${p.code}</small></td>
                <td>${fmt(p.price)}</td>
                <td>${p.stock}</td>
                <td>
                    <button style="border:1px solid #ccc; background:white; cursor:pointer;" onclick="editProd(${p.id})">‚úèÔ∏è</button> 
                    <button style="border:1px solid red; background:white; color:red; cursor:pointer;" onclick="delProd(${p.id})">üóëÔ∏è</button>
                </td>
            </tr>`;
        });
        document.getElementById('tProduct').querySelector('tbody').innerHTML = h;
    }

    function resetForm() {
        document.querySelectorAll('#view-produk input').forEach(i => i.value='');
    }

    // --- KASIR ---
    function renderProducts() {
        let k = document.getElementById('search').value.toLowerCase();
        let h = '';
        db.prod.filter(p => p.name.toLowerCase().includes(k) || p.code.toLowerCase().includes(k)).forEach(p => {
            let cls = p.stock<=0 ? 'out' : (p.stock<=5 ? 'low' : '');
            let bdg = p.stock<=0 ? 'HABIS' : (p.stock<=5 ? 'SISA '+p.stock : '');
            h += `<div class="card ${cls}" onclick="addCart(${p.id})">
                ${bdg ? `<span class="badge ${p.stock<=0?'bg-red':'bg-yellow'}">${bdg}</span>`:''}
                <div class="p-name">${p.name}</div>
                <div class="p-price">${fmt(p.price)}</div>
            </div>`;
        });
        document.getElementById('grid').innerHTML = h;
    }

    function addCart(id) {
        let p = db.prod.find(x => x.id == id);
        if(p.stock <= 0) return alert('Stok Habis');
        let c = db.cart.find(x => x.id == id);
        if(c) {
            if(c.qty < p.stock) c.qty++; else return alert('Stok mentok');
        } else {
            db.cart.push({...p, qty:1});
        }
        renderCart();
    }

    function renderCart() {
        let h='', tot=0, count=0;
        db.cart.forEach(c => {
            tot += c.price * c.qty;
            count += c.qty;
            h += `<div class="cart-item">
                <div style="flex:1;">
                    <div style="font-weight:bold; font-size:0.9rem;">${c.name}</div>
                    <div style="font-size:0.8rem; color:#666;">${fmt(c.price)}</div>
                </div>
                <div class="qty-control">
                    <button class="qty-btn" onclick="updCart(${c.id}, -1)">-</button>
                    <span style="font-weight:bold; min-width:20px; text-align:center;">${c.qty}</span>
                    <button class="qty-btn" onclick="updCart(${c.id}, 1)">+</button>
                </div>
            </div>`;
        });
        document.getElementById('cart').innerHTML = h || '<div style="text-align:center; padding:20px; color:#aaa;">Keranjang Kosong</div>';
        document.getElementById('cartTotal').innerText = fmt(tot);
        document.getElementById('cartCount').innerText = count + ' Item';
    }

    function updCart(id, v) {
        let c = db.cart.find(x => x.id == id);
        let p = db.prod.find(x => x.id == id);
        c.qty += v;
        if(c.qty > p.stock) { c.qty--; alert('Stok kurang'); }
        if(c.qty <= 0) db.cart = db.cart.filter(x => x.id != id);
        renderCart();
    }

    // --- CHECKOUT ---
    function openPay() {
        if(db.cart.length===0) return alert('Keranjang kosong');
        totPay = db.cart.reduce((a,b)=>a+(b.price*b.qty),0);
        document.getElementById('payTotalDisplay').innerText = fmt(totPay);
        
        setMethod('cash');
        document.getElementById('payInput').value = '';
        document.getElementById('debtName').value = '';
        document.getElementById('payChangeDisplay').innerText = 'Rp 0';
        
        document.getElementById('modalPay').style.display = 'flex';
        setTimeout(()=>document.getElementById('payInput').focus(), 100);
    }

    function setMethod(m) {
        payMethod = m;
        let btnCash = document.getElementById('btnMethodCash');
        let btnDebt = document.getElementById('btnMethodDebt');
        let btnProc = document.getElementById('btnProcess');
        
        if(m === 'cash') {
            btnCash.className = 'btn bg-blue'; btnDebt.className = 'btn'; btnDebt.style.background = '#ccc';
            document.getElementById('areaCash').style.display = 'block';
            document.getElementById('areaDebt').style.display = 'none';
            btnProc.innerText = "BAYAR & CETAK";
            calcPay();
        } else {
            btnDebt.className = 'btn bg-blue'; btnCash.className = 'btn'; btnCash.style.background = '#ccc';
            document.getElementById('areaCash').style.display = 'none';
            document.getElementById('areaDebt').style.display = 'block';
            btnProc.innerText = "SIMPAN HUTANG";
            btnProc.disabled = false;
        }
    }

    function quickPay(n) {
        if(n===0) n = totPay;
        document.getElementById('payInput').value = n;
        calcPay();
    }

    function calcPay() {
        if(payMethod !== 'cash') return;
        let val = parseInt(document.getElementById('payInput').value) || 0;
        document.getElementById('payChangeDisplay').innerText = fmt(val - totPay);
        document.getElementById('btnProcess').disabled = val < totPay;
    }

    function processTx() {
        let date = new Date().toLocaleString('id-ID');
        let pay = 0, change = 0, cust = 'Umum';

        if(payMethod === 'cash') {
            pay = parseInt(document.getElementById('payInput').value) || 0;
            change = pay - totPay;
        } else {
            cust = document.getElementById('debtName').value.trim();
            if(!cust) return alert("Nama Pelanggan Wajib Diisi!");
            db.debts.push({
                id: Date.now(),
                date: date,
                name: cust,
                amount: totPay,
                status: 'Belum Lunas',
                items: [...db.cart]
            });
        }
        
        db.cart.forEach(c => {
            let p = db.prod.find(x => x.id == c.id);
            if(p) p.stock -= c.qty;
        });

        let tx = {
            date: date,
            items: [...db.cart],
            total: totPay, pay, change,
            method: payMethod, customer: cust
        };
        db.hist.push(tx);
        
        db.cart = [];
        save();
        printRawBT(tx); // PRINT OTOMATIS
        
        document.getElementById('modalPay').style.display='none';
        renderCart(); renderProducts(); renderHistory(); renderDebts();
    }

    // --- PRINTING (RAWBT INTENT) ---
    function printRawBT(tx) {
        let s = db.set;
        let txt = "";
        
        txt += "[C]<b>" + s.name + "</b>\n";
        txt += "[C]" + tx.date + "\n";
        txt += "--------------------------------\n";
        
        tx.items.forEach(i => {
            txt += "[L]" + i.name + "\n";
            txt += "[L]" + i.qty + " x " + fmt(i.price) + "[R]" + fmt(i.qty*i.price) + "\n";
        });
        
        txt += "--------------------------------\n";
        txt += "[L]TOTAL[R]" + fmt(tx.total) + "\n";
        
        if(tx.method === 'cash') {
            txt += "[L]BAYAR[R]" + fmt(tx.pay) + "\n";
            txt += "[L]KEMBALI[R]" + fmt(tx.change) + "\n";
        } else {
            txt += "[C]*** KASBON: " + tx.customer + " ***\n";
            txt += "[L]STATUS[R]BELUM LUNAS\n";
        }
        
        txt += "--------------------------------\n";
        txt += "[C]" + s.footer + "\n\n\n";

        let S = "#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.data=" + encodeURIComponent(txt) + ";end;";
        window.location.href = "intent:" + S;
    }

    function testPrintRawBT() {
        let txt = "[C]<b>TEST PRINT OK</b>\n[C]Printer Terhubung!\n\n\n";
        window.location.href = "intent:#Intent;scheme=rawbt;package=ru.a402d.rawbtprinter;S.data=" + encodeURIComponent(txt) + ";end;";
    }

    // --- ISLAMIC FEATURES ---
    function updateIslamicDate() {
        let now = new Date();
        // Masehi
        let opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('dateMasehi').innerText = now.toLocaleDateString('id-ID', opts);
        
        // Hijriah (Menggunakan Intl API bawaan browser modern)
        try {
            let hijri = new Intl.DateTimeFormat('id-ID-u-ca-islamic', {day:'numeric', month:'long', year:'numeric'}).format(now);
            document.getElementById('dateHijri').innerText = hijri;
        } catch(e) {
            document.getElementById('dateHijri').innerText = "Hijriah tidak support di browser ini";
        }
    }

    function fetchPrayerTimes() {
        // Ambil dari API Aladhan (Perlu Internet, kalau offline akan fail gracefully)
        if(!navigator.onLine) {
            document.getElementById('jadwalSholatList').innerText = "Offline: Tidak dapat memuat jadwal sholat";
            return;
        }

        // Default Jakarta, bisa dikembangkan dengan Geolocation
        fetch('https://api.aladhan.com/v1/timingsByCity?city=Jakarta&country=Indonesia&method=20')
            .then(res => res.json())
            .then(data => {
                let t = data.data.timings;
                let html = `
                    <div>Subuh: ${t.Fajr}</div>
                    <div>Zuhur: ${t.Dhuhr}</div>
                    <div>Asar: ${t.Asr}</div>
                    <div>Magrib: ${t.Maghrib}</div>
                    <div>Isya: ${t.Isha}</div>
                `;
                document.getElementById('jadwalSholatList').innerHTML = html;
                document.getElementById('prayTime').innerText = `Magrib: ${t.Maghrib}`;
            })
            .catch(e => {
                document.getElementById('jadwalSholatList').innerText = "Gagal memuat jadwal";
            });
    }

    // --- UTILS & SETTINGS ---
    function initSettings() {
        document.getElementById('shopName').value = db.set.name;
        document.getElementById('shopFooter').value = db.set.footer;
        document.getElementById('headTitleText').innerText = db.set.name;
        if(db.set.logo) {
            document.getElementById('logoPreview').src = db.set.logo;
            document.getElementById('logoPreview').style.display = 'block';
            document.getElementById('headLogo').src = db.set.logo;
            document.getElementById('headLogo').style.display = 'block';
        }
    }
    
    function saveSettings() {
        db.set.name = document.getElementById('shopName').value;
        db.set.footer = document.getElementById('shopFooter').value;
        save(); initSettings();
    }
    
    function handleLogo(input) {
        let f = input.files[0]; if(!f) return;
        let r = new FileReader();
        r.onload = e => {
            let img = new Image(); img.src = e.target.result;
            img.onload = () => {
                let c = document.createElement('canvas'); let ctx = c.getContext('2d');
                let scale = 200/img.width; c.width=200; c.height=img.height*scale;
                ctx.drawImage(img,0,0,c.width,c.height);
                db.set.logo = c.toDataURL('image/png'); saveSettings();
            }
        }; r.readAsDataURL(f);
    }

    function handleScan(c) {
        let p = db.prod.find(x => x.code == c);
        if(p) {
            document.getElementById('sndOk').play();
            addCart(p.id);
            if(!document.getElementById('view-kasir').classList.contains('show')) nav('kasir');
        } else {
            document.getElementById('sndNew').play();
            nav('produk');
            resetForm();
            document.getElementById('pCode').value = c;
            alert('Produk baru?');
        }
    }

    function startCam() {
        document.getElementById('cam-layer').style.display='flex';
        if(!scanner) {
            scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 }, false);
            scanner.render((t)=>{handleScan(t); scanner.pause(); setTimeout(()=>scanner.resume(),1000);});
        }
    }
    function stopCam() { document.getElementById('cam-layer').style.display='none'; if(scanner) scanner.clear(); scanner=null; }
    
    function fmt(n) { return 'Rp '+n.toLocaleString('id-ID'); }
    
    function renderHistory() {
        let h='';
        db.hist.slice().reverse().forEach(x => {
            let m = x.method === 'debt' ? '<b style="color:red">HUTANG</b>' : 'Tunai';
            h += `<tr><td>${x.date}</td><td>${fmt(x.total)}</td><td>${m}</td></tr>`;
        });
        document.getElementById('tHistory').querySelector('tbody').innerHTML = h;
    }
    
    function renderDebts() {
        let h = '';
        let unpaid = db.debts.filter(x => x.status === 'Belum Lunas');
        if(unpaid.length === 0) h = '<tr><td colspan="4" style="text-align:center">Tidak ada data</td></tr>';
        else {
            unpaid.forEach(d => {
                h += `<tr><td>${d.date.split(',')[0]}</td><td>${d.name}</td><td>${fmt(d.amount)}</td><td><button class="btn bg-blue" style="padding:4px;" onclick="payDebt(${d.id})">Lunas</button></td></tr>`;
            });
        }
        document.getElementById('tDebt').querySelector('tbody').innerHTML = h;
    }
    
    function payDebt(id) {
        if(confirm("Tandai Lunas?")) {
            let d = db.debts.find(x => x.id == id);
            if(d) { d.status = 'Lunas'; save(); renderDebts(); updateDash(); }
        }
    }
    
    function updateDash() {
        let today = new Date().toLocaleDateString('id-ID');
        let todayTx = db.hist.filter(x => x.date.includes(today)); // Simple check
        let omzet = todayTx.reduce((a,b)=>a+b.total,0);
        let qty = todayTx.reduce((a,b)=>a+b.items.reduce((c,d)=>c+d.qty,0),0);
        let hutang = db.debts.filter(x => x.status === 'Belum Lunas').reduce((a,b)=>a+b.amount,0);
        
        document.getElementById('dashOmzet').innerText = fmt(omzet);
        document.getElementById('dashTerjual').innerText = qty + " Item";
        document.getElementById('dashHutang').innerText = fmt(hutang);

        // Alert
        let low = db.prod.filter(p => p.stock <= 5);
        if(low.length>0) {
            document.getElementById('stockAlert').style.display = 'block';
            document.getElementById('stockAlertList').innerHTML = low.map(p => `<div>${p.name} (Sisa ${p.stock})</div>`).join('');
        } else {
            document.getElementById('stockAlert').style.display = 'none';
        }
    }

    function resetDaily() { if(confirm('Hapus transaksi hari ini?')) { db.hist=[]; save(); renderHistory(); } }
    function downloadBackup() {
        let a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        a.download = 'backup.json'; a.click();
    }
    function restoreData(i) {
        let f=i.files[0]; if(!f)return;
        let r=new FileReader(); r.onload=e=>{db=JSON.parse(e.target.result); save(); location.reload();}; r.readAsText(f);
    }
</script>
</body>
</html>
